---
title: "Untitled"
output: html_document
date: "2024-01-22"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE, message=FALSE}

library(tidyverse)

```

## extract_ocean_data

The `space` argument can either be an area of ocean delimited by a vector of xmin, xmax, ymin, ymax:
`space` = c(70, 75, 2, 6)
or an input of sites:
`space` = "sites.xlsx"

`extract_ocean_data()` shows "Downloading..." and the information of the file being downloaded (dataset, variable, temporal resolution, date range). As of the present version there is no way to show the file size *before* downloading, but the download speed is displayed realtime to track progress. 

```{r, warning=FALSE, message=FALSE}

df <- extract_ocean_data(dataset=5, space = c(70, 71, 1,2), time = c("2010-01-01", "2018-06-01"))  

df2 <- extract_ocean_data(dataset=5, space = "/Users/rof011/rOceanData/datasets/sites.xlsx", time = c("2010-01-01", "2010-01-01"))  

sites <- "/Users/rof011/rOceanData/datasets/H1 site details.csv"

k490 <- extract_ocean_data(dataset="erdMH1kd490mday[k490]", space = sites, time = c("2003-01-01", "2003-01-01"))  

par <- extract_ocean_data(dataset="erdMH1par0mday[par]", space = sites, time = c("2003-01-01", "2024-01-01"))  
chl <- extract_ocean_data(dataset="erdMH1chlamday[chlorophyll]", space = sites, time = c("2003-01-01", "2024-01-01"))  
MUR <- extract_ocean_data(dataset="jplMURSST41mday[sst]", space = sites, time = c("2003-01-01", "2024-01-01"))  
MURanomalies <- extract_ocean_data("dataset=jplMURSST41anommday[sstAnom]", space = sites, time = c("2003-01-01", "2024-01-01"))  

saveRDS(k490, "k490.RDS")
saveRDS(par, "par.RDS")
saveRDS(chl, "chl.RDS")
saveRDS(MUR, "MUR.RDS")
saveRDS(MURanomalies, "MURanomalies.RDS")

MUR$data |>
  mutate(latgrad = as.numeric(latitude)) |>
  ggplot() +
  theme_bw() +
  geom_line(aes(time, analysed_sst, group = site, color = latgrad), linewidth = 0.5) +
  scale_color_distiller(type = "seq", palette = "RdBu")

MUR$data |>
  mutate(latgrad = as.numeric(latitude)) |>
  arrange(latgrad) |> 
  ggplot() + 
  facet_wrap(~site) +
  theme_bw() +
  geom_line(aes(time, analysed_sst, group = site, color = latgrad), linewidth = 0.5) +
  scale_color_distiller(type = "seq", palette = "RdBu")


par$data |>
  mutate(latgrad = as.numeric(latitude)) |>
  arrange(latgrad) |> 
  ggplot() + 
  #facet_wrap(~site) +
  theme_bw() +
  geom_violin(aes(as.factor(latgrad), analysed_sst, group = site, fill = latgrad), linewidth = 0.5) +
  scale_fill_distiller(type = "seq", palette = "RdBu")



```


The output from `extract_ocean_data()` is split into two components: `$data` is the downloaded data and `$metadata` gives the metadata information on the downloaded data: 

```{r , warning=FALSE, message=FALSE}

head(df$data)


head(df$metadata)

```


Once the data is downloaded, you can use the raw data for further analysis with other packages (e.g. `tempdata <- df$data`), or continue with the workflow and distil the data further before mapping or analysing.

## distil_ocean_data

[distil]{.underline} /dɪˈstɪl/ - "extract the essential meaning or most important aspects of"

Once the data is extracted, `distil_ocean_data()` is the second step of the workflow where data can be averaged through space (e.g. reducing the resolution from 1km * 1km to say... 5 * 5km resolution to meaningfully compare datasets) or through time (e.g. finding the average monthly data from a daily dataset). `distil_ocean_data()` has two arguments:

`space` = spatial resolution for grouping

`time` = spatial resolution for grouping



```{r, warning=FALSE, message=FALSE}

data <- df %>% distill_ocean_data(var="sstAnom")

```

The output is the same as the first step with `$data` and `$metadata`, but the `$metadata` is now appended with the new "distilled" datasteps to track changes throughout the workflow.

## map_ocean_data

```{r }

data %>% 
  distill_ocean_data(group="all") %>% 
  map_ocean_data()

```
